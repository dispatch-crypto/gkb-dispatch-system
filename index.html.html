<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dispatch System</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Helper Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Label Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        .step-indicator {
            transition: all 0.3s ease;
            border-color: #d1d5db;
            color: #6b7280;
        }
        .step-indicator.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .step-indicator.completed {
            border-color: #16a34a;
            color: #16a34a;
            background-color: #f0fdf4;
        }
        .file-label {
            border: 2px dashed #cbd5e1;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-label:hover {
            background-color: #f8fafc;
            border-color: #94a3b8;
        }
        .file-label.has-file {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- App Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="bg-white shadow-md rounded-t-lg p-6 border-b">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h13.5c1.036 0 1.875.84 1.875 1.875v14.25c0 1.036-.84 1.875-1.875-1.875H5.625c-1.036 0-1.875-.84-1.875-1.875V4.875z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 18.75h9M7.5 12h9m-9-6.25h9" />
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-800">Smart Dispatch System</h1>
                </div>
                <div id="auth-status" class="text-sm font-medium text-gray-500">Connecting...</div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="bg-white shadow-md rounded-b-lg p-8">
            <!-- Step Indicators -->
            <div class="flex justify-between items-center mb-8">
                <div id="step-indicator-1" class="step-indicator active flex-1 text-center border-b-4 pb-2">Step 1: Upload Files</div>
                <div id="step-indicator-2" class="step-indicator flex-1 text-center border-b-4 pb-2">Step 2: Review & Create</div>
                <div id="step-indicator-3" class="step-indicator flex-1 text-center border-b-4 pb-2">Step 3: Print & Pack</div>
            </div>

            <!-- Step 1: Upload -->
            <div id="step-1" class="step active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Mandatory Upload -->
                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <h2 class="text-xl font-semibold mb-2">Upload Lab Dispatch File</h2>
                        <p class="text-gray-600 mb-4 text-sm">This file is required for daily operations.</p>
                        <label for="lab-dispatch-upload" class="file-label rounded-lg" id="lab-dispatch-label">
                            <span class="font-medium text-gray-600" id="lab-dispatch-text">Click or drag `lab_dispatch.csv` here</span>
                        </label>
                        <input type="file" id="lab-dispatch-upload" class="hidden" accept=".csv" disabled>
                    </div>
                    <!-- Optional Upload -->
                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <h2 class="text-xl font-semibold mb-2">Update Stores (Optional)</h2>
                        <p class="text-gray-600 mb-4 text-sm">Only upload if you need to add or update store details.</p>
                        <label for="stores-upload" class="file-label rounded-lg" id="stores-label">
                            <span class="font-medium text-gray-600" id="stores-text">Click or drag `stores.csv` here</span>
                        </label>
                        <input type="file" id="stores-upload" class="hidden" accept=".csv" disabled>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button id="process-files-btn" class="bg-blue-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors" disabled>
                        Next: Review Dispatch Plan
                    </button>
                </div>
            </div>

            <!-- Step 2: Review -->
            <div id="step-2" class="step">
                 <div class="text-center">
                    <h2 class="text-2xl font-semibold mb-2">Review Dispatch Plan</h2>
                    <p class="text-gray-600 mb-6">Please review the summary below before creating the boxes in the database.</p>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h3 class="font-bold text-lg mb-4 text-blue-800">Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-3xl font-bold text-blue-600" id="summary-orders">0</p>
                            <p class="text-sm font-medium text-gray-500">Valid Lens Orders</p>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-blue-600" id="summary-boxes">0</p>
                            <p class="text-sm font-medium text-gray-500">Consolidated Boxes to Create</p>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-red-600" id="summary-errors">0</p>
                            <p class="text-sm font-medium text-gray-500">Rows with Errors</p>
                        </div>
                    </div>
                </div>
                <div id="error-details-container" class="mt-6 hidden">
                     <h3 class="font-bold text-lg mb-2 text-red-700">Error Details</h3>
                     <div id="error-details" class="bg-red-50 p-4 rounded-lg max-h-40 overflow-y-auto text-sm font-mono"></div>
                </div>
                <div class="text-center mt-8 space-x-4">
                    <button id="back-to-upload-btn" class="text-gray-600 font-semibold py-3 px-8 rounded-lg hover:bg-gray-100">Go Back</button>
                    <button id="confirm-create-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors">
                        Confirm & Create Boxes
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Print & Pack -->
            <div id="step-3" class="step">
                <div class="text-center">
                    <h2 class="text-2xl font-semibold mb-2 text-green-700">Success! Dispatch Plan Created.</h2>
                    <p class="text-gray-600 mb-6">Today's boxes are now in the system. You can print labels and proceed to the Packing Station.</p>
                    <div class="space-x-4">
                        <button id="print-labels-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors">Print Today's Labels</button>
                        <a href="https://gkbdispatch.netlify.app/packing_station.html" id="packing-station-link" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-900 transition-colors" target="_blank">Open Packing Station</a>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 class="font-bold text-lg mb-2">Today's Boxes</h3>
                    <div id="boxes-list" class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto text-sm grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                </div>
                 <div class="text-center mt-8">
                    <button id="start-new-day-btn" class="text-blue-600 font-semibold py-3 px-8 hover:underline">Start New Day / Upload Another File</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Loading Spinner Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p id="loading-text" class="mt-2 text-lg font-medium text-gray-700">Processing...</p>
        </div>
    </div>

    <script type="module">
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://jyzbdkuizwvqamsxqdfg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emJka3Vpend2cWFtc3hxZGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTE2MzUsImV4cCI6MjA2OTk4NzYzNX0.AqcKHtGPjm5fSijgjh8CMzrqRuheDRAefyU0prPwY2I';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global State ---
        let storeMaster = new Map();
        let dispatchData = [];
        let newStoresData = [];
        let processedData = { orders: [], boxes: [], errors: [] };

        // --- UI Elements ---
        const UIElements = {
            steps: document.querySelectorAll('.step'),
            stepIndicators: document.querySelectorAll('.step-indicator'),
            labDispatchUpload: document.getElementById('lab-dispatch-upload'),
            labDispatchLabel: document.getElementById('lab-dispatch-label'),
            labDispatchText: document.getElementById('lab-dispatch-text'),
            storesUpload: document.getElementById('stores-upload'),
            storesLabel: document.getElementById('stores-label'),
            storesText: document.getElementById('stores-text'),
            processFilesBtn: document.getElementById('process-files-btn'),
            confirmCreateBtn: document.getElementById('confirm-create-btn'),
            backToUploadBtn: document.getElementById('back-to-upload-btn'),
            startNewDayBtn: document.getElementById('start-new-day-btn'),
            printLabelsBtn: document.getElementById('print-labels-btn'),
            packingStationLink: document.getElementById('packing-station-link'),
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
        };

        // --- Core Functions ---
        const navigateToStep = (stepNumber) => {
            UIElements.steps.forEach(step => step.classList.remove('active'));
            document.getElementById(`step-${stepNumber}`).classList.add('active');
            UIElements.stepIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    indicator.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    indicator.classList.add('active');
                }
            });
        };

        const showLoading = (show, text = 'Processing...') => {
            UIElements.loadingText.textContent = text;
            UIElements.loadingOverlay.classList.toggle('hidden', !show);
        };

        const fetchStoreMaster = async () => {
            showLoading(true, 'Loading Store Data...');
            const { data, error } = await db.from('stores').select('*, couriers(id, name)');
            
            if (error) {
                showLoading(false);
                alert('FATAL ERROR: Could not load store master data. Please check database connection and refresh.');
                return;
            }
            storeMaster = new Map(data.map(store => [store.store_code, store]));
            console.log(`${storeMaster.size} stores loaded into memory.`);
            
            UIElements.labDispatchUpload.disabled = false;
            UIElements.storesUpload.disabled = false;
            showLoading(false);
        };

        const handleFileSelect = (event, type) => {
            const file = event.target.files[0];
            if (!file) return;

            const label = type === 'lab' ? UIElements.labDispatchLabel : UIElements.storesLabel;
            const textEl = type === 'lab' ? UIElements.labDispatchText : UIElements.storesText;
            
            label.classList.add('has-file');
            textEl.textContent = file.name;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                bom: true,
                complete: (results) => {
                    if (type === 'lab') {
                        dispatchData = results.data;
                    } else {
                        newStoresData = results.data;
                    }
                    UIElements.processFilesBtn.disabled = dispatchData.length === 0;
                }
            });
        };

        const processFiles = async () => {
            showLoading(true, 'Processing files...');
            
            if (newStoresData.length > 0) {
                showLoading(true, 'Updating store master...');
                const couriersToUpsert = new Map();
                newStoresData.forEach(store => {
                    if (store.Courier) {
                        couriersToUpsert.set(store.Courier.trim().toUpperCase(), { name: store.Courier.trim() });
                    }
                });
                if (couriersToUpsert.size > 0) {
                    await db.from('couriers').upsert(Array.from(couriersToUpsert.values()), { onConflict: 'name' });
                }
                
                const { data: couriers } = await db.from('couriers').select('id, name');
                const courierMap = new Map(couriers.map(c => [c.name.toUpperCase(), c.id]));

                const storesToUpsert = newStoresData.map(store => {
                    if(store.store_code && store.store_name) {
                        const courierName = store.Courier?.trim().toUpperCase();
                        return {
                            store_code: store.store_code, store_name: store.store_name, address: store.address,
                            city: store.city, state: store.state, pincode: store.pincode, mobile: store.mobile,
                            courier_id: courierMap.get(courierName) || null
                        };
                    }
                }).filter(Boolean); 

                if (storesToUpsert.length > 0) {
                    await db.from('stores').upsert(storesToUpsert, { onConflict: 'store_code' });
                }
                await fetchStoreMaster();
            }

            showLoading(true, 'Analyzing dispatch plan...');
            const orders = [];
            const boxes = new Map();
            const errors = [];
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const dateSuffix = `${day}${month}`;

            const groups = new Map();
            dispatchData.forEach((row, index) => {
                if (!row.gkb_order_no || !row.customer_ref) {
                    errors.push({ line: index + 2, reason: `Missing gkb_order_no or customer_ref.` }); return;
                }
                const storeCode = row.customer_ref.split('/')[0].trim();
                if (!storeCode) {
                    errors.push({ line: index + 2, reason: 'Could not extract store_code from customer_ref.' }); return;
                }
                const storeInfo = storeMaster.get(storeCode);
                if (!storeInfo) {
                    errors.push({ line: index + 2, reason: `Store code "${storeCode}" not found in database.` }); return;
                }
                if (!storeInfo.delivery_group_id) {
                     errors.push({ line: index + 2, reason: `Store code "${storeCode}" is missing a delivery_group_id. Please update its address in the database.` }); return;
                }

                if (!groups.has(storeInfo.delivery_group_id)) {
                    groups.set(storeInfo.delivery_group_id, []);
                }
                groups.get(storeInfo.delivery_group_id).push(row);
            });

            groups.forEach((orderRows, groupId) => {
                const uniqueStoreCodes = [...new Set(orderRows.map(r => r.customer_ref.split('/')[0].trim()))];
                const firstStoreCode = uniqueStoreCodes[0];
                const firstStoreInfo = storeMaster.get(firstStoreCode);
                
                let boxId;
                if (uniqueStoreCodes.length > 1) {
                    boxId = `BULK-${dateSuffix}-${firstStoreCode}`;
                } else {
                    boxId = `BEN-${dateSuffix}-${firstStoreCode}`;
                }

                if (!boxes.has(boxId)) {
                    boxes.set(boxId, { box_id: boxId, dispatch_date: today.toISOString().split('T')[0], delivery_group_id: firstStoreInfo.delivery_group_id });
                }

                orderRows.forEach(row => {
                     let formattedDate = today.toISOString().split('T')[0];
                    if (row.order_date) {
                        const dateStr = row.order_date.trim();
                        const parts = dateStr.split('-');
                        if (parts.length === 3 && parts[0].length === 2 && parts[1].length === 2 && parts[2].length === 4) {
                            formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    }
                    orders.push({
                        gkb_order_no: row.gkb_order_no, customer_ref: row.customer_ref, store_code: row.customer_ref.split('/')[0].trim(),
                        box_id: boxId, order_date: formattedDate, status: 'Pending'
                    });
                });
            });

            processedData = { orders, boxes: Array.from(boxes.values()), errors };
            
            document.getElementById('summary-orders').textContent = processedData.orders.length;
            document.getElementById('summary-boxes').textContent = processedData.boxes.length;
            document.getElementById('summary-errors').textContent = processedData.errors.length;
            
            const errorContainer = document.getElementById('error-details-container');
            const errorDetailsEl = document.getElementById('error-details');
            if (errors.length > 0) {
                errorContainer.classList.remove('hidden');
                errorDetailsEl.innerHTML = errors.map(e => `<li>Line ${e.line}: ${e.reason}</li>`).join('');
                UIElements.confirmCreateBtn.disabled = true;
                UIElements.confirmCreateBtn.textContent = 'Fix Errors Before Proceeding';
            } else {
                errorContainer.classList.add('hidden');
                UIElements.confirmCreateBtn.disabled = false;
                UIElements.confirmCreateBtn.textContent = 'Confirm & Create Boxes';
            }
            showLoading(false);
            navigateToStep(2);
        };

        const createBoxesInDB = async () => {
            showLoading(true, 'Creating boxes and orders in database...');
            const { boxes, orders, errors } = processedData;
            if (errors.length > 0) { alert('Cannot proceed with errors.'); showLoading(false); return; }

            const { error: boxError } = await db.from('boxes').upsert(boxes, { onConflict: 'box_id' });
            if (boxError) { alert(`Error creating boxes: ${boxError.message}`); showLoading(false); return; }

            const { error: orderError } = await db.from('orders').insert(orders);
            if (orderError) { alert(`Error inserting orders: ${orderError.message}. Some may be duplicates.`); }
            
            document.getElementById('boxes-list').innerHTML = boxes.map(b => `<div class="p-2 border rounded-md bg-white">${b.box_id}</div>`).join('');
            showLoading(false);
            if (!orderError) { navigateToStep(3); }
        };
        
        const printLabels = () => {
            showLoading(true, 'Generating Labels PDF...');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: [288, 432] }); 

            processedData.boxes.forEach((box, index) => {
                const storesInBox = [...new Set(processedData.orders.filter(o => o.box_id === box.box_id).map(o => o.store_code))];
                const firstStore = storeMaster.get(storesInBox[0]);
                if (!firstStore) return;

                if (index > 0) doc.addPage();

                doc.setFontSize(10);
                doc.text('FROM:', 20, 30);
                doc.setFont('helvetica', 'bold');
                doc.text('GKB Eyecare Pvt Ltd', 20, 45);
                doc.setFont('helvetica', 'normal');
                doc.text('B-48, 1st Floor, Sector - 88', 20, 60);
                doc.text('Noida, Uttar Pradesh - 201306', 20, 75);

                doc.line(10, 95, 278, 95);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('TO:', 20, 120);
                doc.setFont('helvetica', 'normal');
                
                const address = `${firstStore.store_name}\n${firstStore.address}, ${firstStore.city}\n${firstStore.state} - ${firstStore.pincode}\nPh: ${firstStore.mobile || 'N/A'}`;
                const addressLines = doc.splitTextToSize(address, 248);
                doc.text(addressLines, 20, 135);
                
                if (storesInBox.length > 1) {
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('CONTAINS ORDERS FOR STORES:', 20, 240);
                    doc.setFont('helvetica', 'normal');
                    doc.text(storesInBox.join(', '), 20, 252, { maxWidth: 248 });
                }

                const barcodeCanvas = document.createElement('canvas');
                JsBarcode(barcodeCanvas, box.box_id, {
                    format: "CODE128", width: 2, height: 40, displayValue: true, fontSize: 14, margin: 10
                });
                doc.addImage(barcodeCanvas.toDataURL(), 'PNG', 20, 300, 248, 60);

                const qr = qrcode(0, 'L');
                // **UPDATED**: This now points to your live Netlify URL
                const verificationUrl = `https://gkbdispatch.netlify.app/customer_confirmation.html?box=${box.box_id}`; 
                qr.addData(verificationUrl);
                qr.make();
                const qrImg = qr.createDataURL(4);
                doc.addImage(qrImg, 'PNG', 200, 370, 68, 68);
            });

            doc.save(`Dispatch_Labels_${new Date().toISOString().split('T')[0]}.pdf`);
            showLoading(false);
        };

        // --- Event Listeners ---
        UIElements.labDispatchUpload.addEventListener('change', (e) => handleFileSelect(e, 'lab'));
        UIElements.storesUpload.addEventListener('change', (e) => handleFileSelect(e, 'stores'));
        UIElements.processFilesBtn.addEventListener('click', processFiles);
        UIElements.backToUploadBtn.addEventListener('click', () => navigateToStep(1));
        UIElements.confirmCreateBtn.addEventListener('click', createBoxesInDB);
        UIElements.printLabelsBtn.addEventListener('click', printLabels);
        UIElements.packingStationLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.open(e.currentTarget.href, '_blank');
        });
        UIElements.startNewDayBtn.addEventListener('click', () => {
            dispatchData = []; newStoresData = [];
            UIElements.processFilesBtn.disabled = true;
            UIElements.labDispatchLabel.classList.remove('has-file');
            UIElements.labDispatchText.textContent = 'Click or drag `lab_dispatch.csv` here';
            UIElements.storesLabel.classList.remove('has-file');
            UIElements.storesText.textContent = 'Click or drag `stores.csv` here';
            navigateToStep(1);
        });
        
        // --- Initial Load ---
        fetchStoreMaster();
        navigateToStep(1);

    </script>
</body>
</html>
